### 4.5.0

在排除类型里增加了“排除已收藏作品”的功能

0   在内页处理            √

1   在内页处理            √

2   列表页-列表页1        √

3   tag页-列表页1         √

4   收藏页-列表页1        √

5   tag搜索页-列表页2     √

6   地区排行榜-列表页3    √

7   其他排行榜-列表页4    √

8   pixivision-不处理     √

9   bookmark_add-在内页处理 √

10  大家的新作品-列表页1  √

11  发现-不处理           √

12	showcase 特辑-不处理  √

13	响应关联作品-不处理    √

### 4.5.2

1. “关注的新作品”（/bookmark_new_illust.php）改版了，列表页规则和tag搜索页一样了。

tag搜索页的模式目前有3个页面在使用：

- tag搜索页
- 发现 discovery
- 关注的新作品

2. “为你推荐”（/recommended.php）合并到发现（/discovery）功能了，但是代码里仍然先保存相关内容。

3. 另外tag搜索页新版刚出的时候是新旧版混合，代码里也对此作了判断。现在看来应该全部换成新版，没有旧版了。但是代码也先保留吧。

### 4.5.5

chrome浏览器进行下载时，会把图片的blob对象在当前标签页打开，不清楚具体原因。给用于下载的a标签添加了 target="_blank"属性解决了。之前没有target属性也可以直接下载的，现在挺奇怪。

### 4.6.0

增加了multiple_down_number参数，可以设置多图作品只下载前几张。默认未限制。

修改后需要刷新页面才会生效，不需要使用时可以改回0。

有时候这是很有用的，有很多的多图作品，只有第一张图是彩色的，后面的图都是黑白的。把multiple_down_number设置为1就可以只下载第一张彩图了。

另外，最近我发现地区排行榜（/ranking_area.php）已经不在首页出现了。

一个已知的问题：

在[每日排行榜](https://www.pixiv.net/ranking.php?mode=daily_r18)，有可能出现最后一张图没抓取完的时候，就提示抓取。这个问题不会影响实际下载的文件数量。

### 4.7.0

增加对pixiv特辑（showcase）的适配；

bug修复。

其他情况:

pixivision在首页原来有4个插画特辑，现在被pixiv自己的特辑（showcase）取代了。在首页只剩下两个推荐特辑的位置，这种类型（推荐）没有做适配。

pixiv特辑（showcase）有[插画](https://www.pixiv.net/showcase/c/illustration/)和[漫画](https://www.pixiv.net/showcase/c/manga/)等分类，本工具只下载插画。漫画的话可以点击进入插画页自行下载。

此外，pixiv特辑滚动到底部时，会加载相似的其他特辑，页面url也会发生改变。本工具下载时会下载当前查看的特辑。

### 4.7.1

修正的问题：

1.大家的新作品里，有按类型分类的页面，之前都是按“综合”处理的，现在可以正确按当前类型获取了。

2.之前无法正常下载关注的新作品的r18分类，现在已经修复。

原本想给排行榜增加手动删除按钮，但是做了之后又去掉了。因为排行榜是分多个部分的，所以获取的时候要通过ajax抓取，在页面上删除没有意义。

### 4.7.2

修复了在tag搜索页里，搜索中断之后，下载时图片网址可能数量异常的问题。

### 4.8.0

- tag搜索页的快速搜索功能可以保持当前搜索模式（全部/普通/R-18）和排序模式

- 优化下载排行榜作品的代码

- 适应pixivision改版

- 增加了对“响应关联作品”的适配

ps0：pixivision改版后，插画页面的头图不是单独的图片了，所以不用单独获取了。

ps1：响应关联作品大部分都比较少，我还没看到超过一页的。目前按作品列表页进行处理，默认下载所有页面。如果有发现分页的话可以告诉我。

ps2：其他排行榜里获取页面时，之前的代码是通过分析dom获得作品数据的。最近发现可以直接获取到json数据了，但是缺少扩展名信息。所以现在只是从json里取得作品页url，其他信息仍然去抓取作品页。

[json示例]https://www.pixiv.net/ranking.php?mode=monthly&content=illust&p=1&format=json

#### 截止2018/2/21，各个排行榜的综合类型的页数（每个排行榜的细分类型的页数和综合不一定相同）：

**普通的有7种排行榜**

- (今日：10页)[https://www.pixiv.net/ranking.php?mode=daily]

- (本周：10页)[https://www.pixiv.net/ranking.php?mode=weekly]

- (本月：10页)[https://www.pixiv.net/ranking.php?mode=monthly]

- (新人：6页)[https://www.pixiv.net/ranking.php?mode=rookie]

- (原创：6页)[https://www.pixiv.net/ranking.php?mode=original]

- (受男性欢迎：10页)[https://www.pixiv.net/ranking.php?mode=male]

- (受女性欢迎：10页)[https://www.pixiv.net/ranking.php?mode=female]

**R-18有4种排行榜**

- (今日r18：2页)[https://www.pixiv.net/ranking.php?mode=daily_r18]

- (本周r18:2页)[https://www.pixiv.net/ranking.php?mode=weekly_r18]

- (受男性欢迎r18：6页)[https://www.pixiv.net/ranking.php?mode=male_r18]

- (受女性欢迎r18：6页)[https://www.pixiv.net/ranking.php?mode=female_r18]

**R-18G只有一种排行榜**

- (r18g：1页)[https://www.pixiv.net/ranking.php?mode=r18g]

### 5.0.0

bug修复和代码优化。

ps1：模板字符串虽然好用，但如果原来的语句里的运算步骤复杂的话，这部分还是用加号拼接比较好。用模板字符串层层嵌套，连在一起之后使代码变得很难读。而且编辑器对于模板字符串里面代码的着色也很差。

ps2：箭头函数也建议只对简单函数使用。如果要处理动态this和使用arguments的话，要使用传统函数。

### 5.0.3

在4.5.5版本里，原本下载链接没加target="_blank"，下载时却会打开新页面，后来加上之后反倒不打开了。然而现在chrome更新到65之后，加了target="_blank"的开始出现新页面了，我只好再去掉。很奇怪。

### 5.0.6

- tag搜索页下载时按照收藏数从高到低下载。

tag搜索页有时图片太多，比如筛选某个tag，条件是最低收藏数3000，有两千来张。下载花了很久，下载的时候我就想，早知道就只下载4000以上的了，低于4000的就不要了。但是由于之前的下载顺序是从低到高，3000 → 4000 → 5000…… 后悔的时候已经晚了。

现在改成了从高到低下载，10000 → 9000 → 8000…… 这样，当你感觉“到这里已经够了”的时候，就可以立即停止下载了。那些收藏数低的不想要就不要了。

### 5.1.0

2018/4/12，最近有不少人遇到有漏下的情况，但是以前一直没这个问题。而且tampermonkey里确实是每个图片都下载到了，下载请求也发送到chrome了，但是漏下的这些任务失败了，并且没有显示在Chrome的下载列表里。最可能的原因是在短时间内点击了多次下载按钮，导致发送了多次下载请求。但是以前一直没问题，推测可能是chrome新版有什么改动导致的问题。

目前有两个思路解决这个漏下的问题，方法1是把并发下载线程 download_thread_deauflt 改成1，单线程下载，不会漏下。方法2是保证每两次点击下载按钮之间有足够的时间间隔，这样既可以多线程下载，也不会漏下。目前采用第二种方法。

### 5.2.0

1.任务流程改为在title上提醒，不再使用弹窗。（但可设置use_alert参数继续使用弹窗）

提示字符的含义：

```
0	复原
↑	抓取中
→	等待下一步操作（tag搜索页）
▶ 	准备下载
↓	下载中
║	下载暂停
■	下载停止
√	下载完毕
```

2.可以保存用户的命名规则。

3.修复pixivision上cosplay图片的下载

4.GM_xmlhttpRequest可以把responseType设置为blob了，不用再手动转换为blob了。这应该会提升运行效率……

另外，极少数情况下，下载面板上的总数量会漏掉一个作品的图片数量，导致已下载数量超过总数量，如295/265。这里只是显示问题，以已下载数量为准。目前对此问题还没有什么头绪。

### 5.3.0

2018年4月份开始，p站陆续对作品页进行改版。不仅页面结构全变了，而且作品也内也不使用jQuery了。

此版本先修复在作品页外下载的问题。

在作品页内下载还不行，先在 _无权访问1 里添加提示。下个版本再修改。

另外，新版直接显示收藏数了，等以后统一是新版了，可以更新到命名规则里。

后续还要添加下载相关作品的功能。

### 5.4.0

更改了获取语言设置的方法。

在作品引入了jQuery，并修复了作品页的下载功能。

在作品页修改了css样式，以保持统一。

### 5.5.0

**新增功能：**

- 支持下载相关作品（作品页下方的相关作品）

相关作品里出现的作品其实和添加收藏后的相似作品是一致的。但是相关作品有个自己的api，如：

https://www.pixiv.net/ajax/illust/68375792/recommend/init?limit=180

这个api最大可以返回180个作品，但相似作品的上限要大得多。所以下载相关作品时，借用相似作品的下载流程。

**bug修复：**

- p站改版后，作品页面切换作品不刷新了。这可能会导致下载到的始终是第一页，对此问题进行了修复。

- 解决漏下illustType为1的作品的bug。

**优化修改：**

- 使用了新版作品页用于获取作品信息的api，如：

https://www.pixiv.net/ajax/illust/67050051

注意最后不能带斜杠。这个api老版也能用，所以 getIllustPage() 里不需要区分新旧版了，直接都改成用新版的。

*但新的api有个问题，就是可能无法获取到作者名字。userName只能从tag信息里获取，如果一个作品没有tag，那就获取不到作者名字了。发生这种情况时，把作者名字留空。*

- 从新的api里可以直接获取多p作品的原图url，并且后缀名是正确的。这样就省下了一次页面抓取，加快了多p作品的抓取速度。

- 优化了命名规则。

- 修改了处理404的代码。之前获取作品页的时候获取的是html页面，404了也可以进入success处理。现在改为获取json数据了，404不进入success了，要在外面statusCode里处理。

### 5.6.0

**新增功能：**

- 在 showcase 特辑里面也可以使用全部的命名方式了。

- 命名规则里都可以使用{bmk}了。（之前只有在tag搜索页可以用）

- 添加了筛选收藏数的按钮。（大于等于指定收藏数的作品才会被下载）

**其他**

- 获取动图信息有新的api，在作品信息api后面加上/ugoira_meta，如：

https://www.pixiv.net/ajax/illust/68437318/ugoira_meta

这里面包含原文件（zip）的url和帧率信息。

- pixivision 预计以后不再维护。

首先它和pixiv主站是跨域的，使得同步下载流程比较麻烦。（比如我计划在pixiv特辑里也去获取作品信息api，这样在pixiv特辑里下载时，可以使用更多的命名规则了。但是jQuery的ajax无法设置跨域，用GM_xmlhttpRequest的话改动成本又太高）。

其次pixivision上面的很多板块都已经停止更新了，插画没有停止更新，但是插画是和showcase 特辑同步的，所以从showcase 特辑下载就行了。

### 5.6.1

原本tag搜索页的快速搜索功能， 最大只到10000users入り。但是这个tag从其本意来讲，是10000-20000，这样，更高收藏数的作品就筛选不出来了。所以现在增加了20000/30000/50000的选项。

### 5.6.2

tag搜索页和大家关注的新作品都有一次改版，改版前是源码里包含着列表的DOM元素，改版后是把作品信息改成json方式保存到源码里了。因为p站的改版一直是新旧版共存过渡，所以当时有个tag_search_is_new参数来区别新旧版。但是到现在应该所有人都改成新版了。tag搜索页可以把tag_search_is_new去掉，但是page_type === 10里面还要留着。因为10里面的大家的新作品是旧版，关注的人的新作品是新版，这俩还得区分。现在先把tag搜索页的旧代码去掉了，并把tag_search_is_new改成list_is_new。

### 5.6.4

p站自己用的jQuery地址为：
https://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js

之前我担心有些人用改dns的方法上p站的话，可能打不开google的网址，所以用了下面的网址：
https://code.jquery.com/jquery-2.0.3.min.js

但是有人打不开这个。怀疑是少数。如果人再有人打不开jquery官网的这个，就改成p站自己的网址吧。

### 5.6.6

前些版本我更改了命名规则，现在有人想用原来的格式，增加了 use_original_name 参数来控制该选项。

### 5.6.7

屏蔽了新版的一些广告

### 5.6.8

#### 添加一键收藏功能，并且附带tag。（只在新版有用）

但是此功能目前有个小瑕疵，如果点了快速收藏，之后向前/后切换一张作品，再切换回来，回来之后会看到又变成没有收藏时的状态了。这是因为页面没有刷新，不要介意。只要快速收藏时显示了收藏成功就没问题。

同时还有其他问题要注意：

- 免费用户每个作品只能添加 10 个 tag，如果作品的 tag 数量超过10个，那么多出来的就不会被保存。

- 收藏时添加的 tag 貌似有 20 个字符的最大长度限制，如添加“バーチャルYouTuber5000users入り”会被截断成为“バーチャルYouTuber5000use”，即使是手动添加也会被截断。

##### 一键收藏功能 API：

```https://www.pixiv.net/rpc/index.php```

以 post 方式发送一些参数（并且需要发送 cookie），示例：

```
mode: save_illust_bookmark
illust_id: 68201395
restrict: 0
comment:
tags: Fate/GrandOrder セイバー・ブライド
tt: 489520361bf22a5bb897306b3d9cdc1b
```

参数说明：

```
mode: save_illust_bookmark 此项固定

illust_id: 68201395 id 按需要修改

restrict: 0 此项固定

comment: 保持留空即可

tag：格式为 encodeURI 编码后的字符，如果要添加多个tag，不同tag之间用空格分开（%20）。

tt：可以从 pixiv 页面上的全局变量获取：globalInitData.token
```

另外，删除收藏用的不是这个 api，而且使用的 id 也不是作品 id，而是该书签的 bookmark_id。

### 5.7.0

#### 增加看图模式（只在新版、多 p 作品页有用）

有普通看图和全屏看图模式。[查看效果（新浪微博](https://weibo.com/1678634987/GmpQnpafZ)

- 使用了 [Viewer.js](https://github.com/fengyuanchen/viewerjs) 库，感谢原作者~

Viewer.js 本来需要引入两个文件，js 文件和 css 文件，为了方便调用，我将两个文件混合后上传到了 greasyfork 上。url 为：

```
https://greasyfork.org/scripts/369647-viewer-js-mix/code/Viewerjs%20mix.js
```

- 注意：

有些时候 greasyfork.org 也会被墙，如果打不开上面的 js，那么自然也就无法使用看图模式了。

- 优化了 Viewer.js 的看图体验。

比如要看图片的100%比例大小的时候，原本一直有查看器的元素挡在图片上，看着不舒服。播放幻灯片的话可以进入全屏模式，会隐藏这些元素，但是图片比例不是100%了。现在我结合了一下，点击 1:1 按钮时会进入全屏状态查看，比例是100%。（必须要点击这个按钮，因为进入全屏需要用户手动操作触发）

原本的全屏状态里（播放幻灯片时），用户不能切换图片，现在全屏状态下也可以切换图片了，并且图片都是保持100%比例打开的。但是有个瑕疵，可能因为 Viewer.js 本来没有设计这个功能，导致图片放大时位置会变化，看上去产生了抖动。

- 注意：

不要用左右方向键 ← → 来切换图片，因为这样会导致 pixiv 也响应了左右方向键，从而切换了作品。还是用鼠标来切换图片吧。

你在p站切换作品时，推荐使用左右方向键 ← →。如果用浏览器的前进后退按钮来操作，那么切换到的这个页面不会触发快速收藏和看图模式。

- pixiv 上缩略图的 url 开头是这样的， ```https://i.pximg.net/c/240x240/img-master/img/```，例如：

```
https://i.pximg.net/c/240x240/img-master/img/2018/06/17/00/10/40/69264102_p4_master1200.jpg
```

这样加载就会很快了，如果加载大图的话，速度就太慢了。

缩略图始终都是 jpg 格式，原图则有 jpg、png 两种格式。（还会有 zip 的）

### 5.7.1

优化了看图体验。

原本在全屏模式（100%比例）中看图时，如果图片是之前尚未加载的图片，那么加载后显示的比例不是100%。现在手动给它设置一次宽高，成为100%。

#### pixiv网址的缩写：

最近发现画师页面和作品页面的网址都可以使用缩写，如：

```
https://www.pixiv.net/member.php?id=212801
缩写为：
https://www.pixiv.net/u/212801

https://www.pixiv.net/member_illust.php?mode=medium&illust_id=66509867
缩写为：
https://www.pixiv.net/i/66509867
```

### 5.7.2

- 可以在下载前预览图片的名字;

- 恢复了单图原来的命名规则，即加上 _p0。

预览图片名的结果如下：

```
69052408_p0.png: bmk_8262-69052408_p0-tags_電撃文庫,ガーリー・エアフォース,おへそ,グリペン,ピンク髪ロング,5000users入り.png
```

每个名字前面加了这个图片默认的名字，如 69052408_p0.png。默认名字和实际名字中间用 ```: ``` 分割。

这样，如果用户使用迅雷、IDM 之类软件下载图片，下载后的图片只有默认名字，再拷贝本工具的命名，就可以编写脚本，把图片的默认名字修改为本工具的名字。

以 cmd 为例，可以把上面的名字修改为 cmd 命令来执行：

```
ren 69052408_p0.png "bmk_8262-69052408_p0-tags_電撃文庫,ガーリー・エアフォース,おへそ,グリペン,ピンク髪ロング,5000users入り.png"
```

借助文本编辑器，用户可以批量的把本工具生成的图片名修改为 shell 命令。