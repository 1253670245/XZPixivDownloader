### 4.5.0

在排除类型里增加了“排除已收藏作品”的功能

0   在内页处理            √

1   在内页处理            √

2   列表页-列表页1        √

3   tag页-列表页1         √

4   收藏页-列表页1        √

5   tag搜索页-列表页2     √

6   地区排行榜-列表页3    √

7   其他排行榜-列表页4    √

8   pixivision-不处理     √

9   bookmark_add-在内页处理 √

10  大家的新作品-列表页1  √

11  发现-不处理           √

12	showcase 特辑-不处理  √

13	响应关联作品-不处理    √

### 4.5.2

1. “关注的新作品”（/bookmark_new_illust.php）改版了，列表页规则和tag搜索页一样了。

tag搜索页的模式目前有3个页面在使用：

- tag搜索页
- 发现 discovery
- 关注的新作品

2. “为你推荐”（/recommended.php）合并到发现（/discovery）功能了，但是代码里仍然先保存相关内容。

3. 另外tag搜索页新版刚出的时候是新旧版混合，代码里也对此作了判断。现在看来应该全部换成新版，没有旧版了。但是代码也先保留吧。

### 4.5.5

chrome浏览器进行下载时，会把图片的blob对象在当前标签页打开，不清楚具体原因。给用于下载的a标签添加了 target="_blank"属性解决了。之前没有target属性也可以直接下载的，现在挺奇怪。

### 4.6.0

增加了multiple_down_number参数，可以设置多图作品只下载前几张。默认未限制。

修改后需要刷新页面才会生效，不需要使用时可以改回0。

有时候这是很有用的，有很多的多图作品，只有第一张图是彩色的，后面的图都是黑白的。把multiple_down_number设置为1就可以只下载第一张彩图了。

另外，最近我发现地区排行榜（/ranking_area.php）已经不在首页出现了。

一个已知的问题：

在[每日排行榜](https://www.pixiv.net/ranking.php?mode=daily_r18)，有可能出现最后一张图没抓取完的时候，就提示抓取。这个问题不会影响实际下载的文件数量。

### 4.7.0

增加对pixiv特辑（showcase）的适配；

bug修复。

其他情况:

pixivision在首页原来有4个插画特辑，现在被pixiv自己的特辑（showcase）取代了。在首页只剩下两个推荐特辑的位置，这种类型（推荐）没有做适配。

pixiv特辑（showcase）有[插画](https://www.pixiv.net/showcase/c/illustration/)和[漫画](https://www.pixiv.net/showcase/c/manga/)等分类，本工具只下载插画。漫画的话可以点击进入插画页自行下载。

此外，pixiv特辑滚动到底部时，会加载相似的其他特辑，页面url也会发生改变。本工具下载时会下载当前查看的特辑。

### 4.7.1

修正的问题：

1.大家的新作品里，有按类型分类的页面，之前都是按“综合”处理的，现在可以正确按当前类型获取了。

2.之前无法正常下载关注的新作品的r18分类，现在已经修复。

原本想给排行榜增加手动删除按钮，但是做了之后又去掉了。因为排行榜是分多个部分的，所以获取的时候要通过ajax抓取，在页面上删除没有意义。

### 4.7.2

修复了在tag搜索页里，搜索中断之后，下载时图片网址可能数量异常的问题。

### 4.8.0

- tag搜索页的快速搜索功能可以保持当前搜索模式（全部/普通/R-18）和排序模式

- 优化下载排行榜作品的代码

- 适应pixivision改版

- 增加了对“响应关联作品”的适配

ps0：pixivision改版后，插画页面的头图不是单独的图片了，所以不用单独获取了。

ps1：响应关联作品大部分都比较少，我还没看到超过一页的。目前按作品列表页进行处理，默认下载所有页面。如果有发现分页的话可以告诉我。

ps2：其他排行榜里获取页面时，之前的代码是通过分析dom获得作品数据的。最近发现可以直接获取到json数据了，但是缺少扩展名信息。所以现在只是从json里取得作品页url，其他信息仍然去抓取作品页。

[json示例]https://www.pixiv.net/ranking.php?mode=monthly&content=illust&p=1&format=json

#### 截止2018/2/21，各个排行榜的综合类型的页数（每个排行榜的细分类型的页数和综合不一定相同）：

**普通的有7种排行榜**

- (今日：10页)[https://www.pixiv.net/ranking.php?mode=daily]

- (本周：10页)[https://www.pixiv.net/ranking.php?mode=weekly]

- (本月：10页)[https://www.pixiv.net/ranking.php?mode=monthly]

- (新人：6页)[https://www.pixiv.net/ranking.php?mode=rookie]

- (原创：6页)[https://www.pixiv.net/ranking.php?mode=original]

- (受男性欢迎：10页)[https://www.pixiv.net/ranking.php?mode=male]

- (受女性欢迎：10页)[https://www.pixiv.net/ranking.php?mode=female]

**R-18有4种排行榜**

- (今日r18：2页)[https://www.pixiv.net/ranking.php?mode=daily_r18]

- (本周r18:2页)[https://www.pixiv.net/ranking.php?mode=weekly_r18]

- (受男性欢迎r18：6页)[https://www.pixiv.net/ranking.php?mode=male_r18]

- (受女性欢迎r18：6页)[https://www.pixiv.net/ranking.php?mode=female_r18]

**R-18G只有一种排行榜**

- (r18g：1页)[https://www.pixiv.net/ranking.php?mode=r18g]

### 5.0.0

bug修复和代码优化。

ps1：模板字符串虽然好用，但如果原来的语句里的运算步骤复杂的话，这部分还是用加号拼接比较好。用模板字符串层层嵌套，连在一起之后使代码变得很难读。而且编辑器对于模板字符串里面代码的着色也很差。

ps2：箭头函数也建议只对简单函数使用。如果要处理动态this和使用arguments的话，要使用传统函数。

### 5.0.3

在4.5.5版本里，原本下载链接没加target="_blank"，下载时却会打开新页面，后来加上之后反倒不打开了。然而现在chrome更新到65之后，加了target="_blank"的开始出现新页面了，我只好再去掉。很奇怪。

### 5.0.6

tag搜索页下载时按照收藏数从高到低下载。

tag搜索页有时图片太多，比如筛选某个tag，条件是最低收藏数3000，有两千来张。下载花了很久，下载的时候我就想，早知道就只下载4000以上的了，低于4000的就不要了。但是由于之前的下载顺序是从低到高，3000 → 4000 → 5000…… 后悔的时候已经晚了。

现在改成了从高到低下载，10000 → 9000 → 8000…… 这样，当你感觉“到这里已经够了”的时候，就可以立即停止下载了。那些收藏数低的不想要就不要了。

### 5.1.0

2018/4/12，最近有不少人遇到有漏下的情况，但是以前一直没这个问题。而且tampermonkey里确实是每个图片都下载到了，下载请求也发送到chrome了，但是漏下的这些任务失败了，并且没有显示在Chrome的下载列表里。最可能的原因是在短时间内点击了多次下载按钮，导致发送了多次下载请求。但是以前一直没问题，推测可能是chrome新版有什么改动导致的问题。

目前有两个思路解决这个漏下的问题，方法1是把并发下载线程 download_thread_deauflt 改成1，单线程下载，不会漏下。方法2是保证每两次点击下载按钮之间有足够的时间间隔，这样既可以多线程下载，也不会漏下。目前采用第二种方法。

### 5.2.0

1.任务流程改为在title上提醒，不再使用弹窗。（但可设置use_alert参数继续使用弹窗）

提示字符的含义：

```
0	复原
↑	抓取中
→	等待下一步操作（tag搜索页）
▶ 	准备下载
↓	下载中
║	下载暂停
■	下载停止
√	下载完毕
```

2.可以保存用户的命名规则。

3.修复pixivision上cosplay图片的下载

4.GM_xmlhttpRequest可以把responseType设置为blob了，不用再手动转换为blob了。这应该会提升运行效率……

另外，极少数情况下，下载面板上的总数量会漏掉一个作品的图片数量，导致已下载数量超过总数量，如295/265。这里只是显示问题，以已下载数量为准。目前对此问题还没有什么头绪。

### 5.3.0

2018年4月份开始，p站陆续对作品页进行改版。不仅页面结构全变了，而且作品也内也不使用jQuery了。

此版本先修复在作品页外下载的问题。

在作品页内下载还不行，先在 _无权访问1 里添加提示。下个版本再修改。

另外，新版直接显示收藏数了，等以后统一是新版了，可以更新到命名规则里。

后续还要添加下载相关作品的功能。

### 5.4.0

更改了获取语言设置的方法。

在作品引入了jQuery，并修复了作品页的下载功能。

在作品页修改了css样式，以保持同意。